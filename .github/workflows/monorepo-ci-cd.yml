name: Monorepo CI/CD

on:
  push:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run all steps except the final publish (semantic-release)'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      packages-to-run: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed packages
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: .github/filters.yml
          base: main

  ci-and-deploy:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.packages-to-run != '[]'
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJSON(needs.detect-changes.outputs.packages-to-run) }}

    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

    steps:
      - name: Generate token from GitHub App
        # This step runs for each matrix job to get a fresh token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        # Use the generated token to checkout, which is good practice
        with:
          token: ${{ steps.generate-token.outputs.token }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js and cache pnpm dependencies
        uses: actions/setup-node@v4
        with:
          node-version: '21'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests for ${{ matrix.package }}
        run: pnpm turbo run test --filter="@orga-ai/${{ matrix.package }}"

      - name: Build package ${{ matrix.package }}
        run: pnpm turbo run build --filter="@orga-ai/${{ matrix.package }}"

      - name: Create pruned monorepo subset for ${{ matrix.package }}
        run: pnpm turbo prune --scope=@orga-ai/${{ matrix.package }} --docker

      - name: Copy build output to pruned subset
        run: cp -R packages/client/${{ matrix.package }}/dist out/packages/client/${{ matrix.package }}/

      - name: Install pruned dependencies
        working-directory: ./out
        run: pnpm install --frozen-lockfile

      - name: Publish with semantic-release for ${{ matrix.package }}
        if: >
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && !startsWith(github.event.head_commit.message, 'chore(release):')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == false)
        working-directory: ./out
        run: pnpm --filter="@orga-ai/${{ matrix.package }}" exec semantic-release
        env:
          # IMPORTANT: Use the token generated by the step above
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}